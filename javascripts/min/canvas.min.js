var context,clickX=new Array,clickY=new Array,clickColor=new Array,clickDrag=new Array,idx=0,paint,buoyRed="#d10c0c",buoyGreen="#028c0e",buoyYellow="#e6f727",pathMarkerBrown="#441a04",startGateOrange="#ff6614",octogonBlk="#0a0807",curColor=buoyRed,image,curImgURL="",imageURLFile="https://raw.githubusercontent.com/shadySource/DATA/master/underwater/url.txt",imageURLs=new Array,tmpLabel,labels=new Array;labels.push("Number of labels: 0");var info;$(window).on("load",function(){document.getElementById("numLabels").innerHTML=labels[0],context=document.getElementById("pictureCanvas").getContext("2d"),$.get(imageURLFile,function(e){imageURLs=e.split("\n"),newImage(),$.getJSON("https://freegeoip.net/json/?callback=?",function(e){function t(e,t,n){clickX.push(e),clickY.push(t),clickDrag.push(n),clickColor.push(curColor)}function n(e){e.lineJoin="round",e.lineWidth=10;for(var t=idx;t<clickX.length;t++)e.beginPath(),clickDrag[t]&&t?e.moveTo(clickX[t-1],clickY[t-1]):e.moveTo(clickX[t]-1,clickY[t]),e.lineTo(clickX[t],clickY[t]),e.closePath(),e.strokeStyle=clickColor[t],e.stroke();idx=clickX.length}function o(){var e=Math.floor(Math.random()*imageURLs.length),t=new Image;t.onload=function(){image=t,curImgURL=imageURLs[e],context.drawImage(image,0,0,context.canvas.width,context.canvas.height)},t.src=imageURLs[e]}function a(){idx=0,clickX=new Array,clickY=new Array,clickColor=new Array,clickDrag=new Array}function c(e){inc=new String;for(var t=0;t<e.length;t++)inc+=String.fromCharCode(e.charCodeAt(t)+1);return inc}function r(){var e=l(context.canvas.width,context.canvas.height);idx=0,n(e);var t=u(e),o=.1*context.canvas.width,a=.1*context.canvas.height;e.clearRect(0,0,o,a),e.drawImage(t,0,0,o,a);var c=e.getImageData(0,0,o,a);o=4*o;for(var r=c.data,i=!0,g=curImgURL+"\n",f=0;f<r.length;f+=4){var m=r[f],h=r[f+1],b=r[f+2],d=s(m,h,b);d===buoyRed?(g+="R",i&&(i=!1)):d===buoyGreen?(g+="G",i&&(i=!1)):d===buoyYellow?(g+="Y",i&&(i=!1)):d===pathMarkerBrown?(g+="M",i&&(i=!1)):d===startGateOrange?(g+="S",i&&(i=!1)):g+=d===octogonBlk?"C":"0",f%o===0&&(g+="\n")}return i?"EMPTY":"\n"+g+"\n"}function l(e,t){var n=document.createElement("canvas");return n.width=e,n.height=t,n.getContext("2d")}function u(e){var t=new Image;return t.src=e.canvas.toDataURL(),t.onload=function(){return t},t.onload()}function s(e,t,n){return"#"+g(e)+g(t)+g(n)}function g(e){return e=parseInt(e,10),isNaN(e)?"00":(e=Math.max(0,Math.min(e,255)),"0123456789abcdef".charAt((e-e%16)/16)+"0123456789abcdef".charAt(e%16))}info=JSON.stringify(e),info=c(info),$("#pictureCanvas").mousedown(function(e){e.pageX-this.offsetLeft,e.pageY-this.offsetTop;return paint=!0,t(e.pageX-this.offsetLeft,e.pageY-this.offsetTop),n(context),!1}),$("#pictureCanvas").mousemove(function(e){return paint?(t(e.pageX-this.offsetLeft,e.pageY-this.offsetTop,!0),n(context),!1):void 0}),$("#pictureCanvas").mouseup(function(e){return paint=!1,!1}),$("#pictureCanvas").mouseleave(function(e){return paint=!1,!1}),$("#clearButton").click(function(){context.drawImage(image,0,0,context.canvas.width,context.canvas.height),a()}),$("#bRBtn").click(function(){curColor=buoyRed}),$("#bGBtn").click(function(){curColor=buoyGreen}),$("#bYBtn").click(function(){curColor=buoyYellow}),$("#PMBtn").click(function(){curColor=pathMarkerBrown}),$("#SGBtn").click(function(){curColor=startGateOrange}),$("#OCTbtn").click(function(){curColor=octogonBlk}),$("#submitButton").click(function(){labels.push(r()),"EMPTY"==labels[labels.length-1]&&labels.pop(),labels[0]="Number of labels: "+(labels.length-1).toString(),document.getElementById("numLabels").innerHTML=labels[0]}),$("#unSubmitButton").click(function(){labels.length>1&&labels.pop(),labels[0]="Number of labels: "+(labels.length-1).toString(),document.getElementById("numLabels").innerHTML=labels[0]}),$("#newImageButton").click(function(){o(),a()}),$("#downloadButton").click(function(){var e=new Date,t=e.getFullYear().toString()+"y"+e.getMonth().toString()+"m"+e.getDate().toString()+"d"+e.getHours().toString()+"h"+e.getMinutes().toString()+"m"+e.getSeconds().toString()+"s"+e.getMilliseconds().toString(),n=info+"\n";for(i=0;i<labels.length;i++)n+=labels[i];var o=new Blob([n],{type:"text/plain;charset=utf-8"});labels.length>1&&saveAs(o,t),tmpLabels=new Array,labels=new Array,labels.push("Number of labels: 0"),document.getElementById("numLabels").innerHTML=labels[0]}),$("#emailButton").click(function(){var e=$("#nameBox").val();""==e&&(e="AnonymousUser"),console.log(e),document.location="mailto:shadysourcebot@gmail.com?subject="+e+"&body="+info})})})});